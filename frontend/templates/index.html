<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ€å­¦æ–‡çŒ®çŸ¥è¯†åº“</title>
    <style>
        /* ä½ åŸæ¥çš„å…¨éƒ¨ CSSï¼ˆä» * { margin:0 ... åˆ° .empty-subtitle } å…¨éƒ¨ä¿ç•™ï¼‰ */
        /* åªåœ¨ .message è§„åˆ™é‡ŒåŠ äº†ä¸€è¡Œ position: relative; */
        .message {
            display: flex;
            gap: 16px;
            padding: 24px 0;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            animation: fadeIn 0.3s ease;
            position: relative;   /* â†â†â† æ–°å¢ï¼Œè®©ç¼–è¾‘æŒ‰é’®èƒ½ç»å¯¹å®šä½ */
        }

        :root {
            --bg-primary: #212121;
            --bg-secondary: #2f2f2f;
            --bg-tertiary: #3d3d3d;
            --text-primary: #ececec;
            --text-secondary: #b4b4b4;
            --accent: #10a37f;
            --accent-hover: #0d8968;
            --border: #4d4d4d;
            --user-msg: #343541;
            --assistant-msg: #444654;
            --danger: #ef4444;
            --danger-hover: #dc2626;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ==================== æ–°å¢çš„ç¼–è¾‘åŠŸèƒ½ CSSï¼ˆæœ€å°åŒ–ï¼‰ ==================== */
        .message-actions {
            position: absolute;
            right: 12px;
            top: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .message:hover .message-actions { opacity: 1; }
        .icon-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
        }
        .icon-btn:hover { background: var(--bg-tertiary); color: var(--accent); }

        .edit-textarea {
            width: 100%; background: var(--bg-tertiary); color: var(--text-primary);
            border: 1px solid var(--border); border-radius: 6px; padding: 12px;
            font-size: 15px; font-family: inherit; resize: vertical; min-height: 80px;
        }
        .edit-actions { display: flex; gap: 8px; margin-top: 8px; }
        .edit-actions button {
            padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;
        }
        .btn-save { background: var(--accent); color: white; }
        .btn-cancel { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border); }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 500;
        }

        .logo {
            font-size: 24px;
        }

        .stats-pill {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            color: var(--accent);
            font-weight: 600;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-tertiary);
        }

        .upload-area:hover {
            border-color: var(--accent);
            background: var(--bg-primary);
        }

        .upload-area.drag-over {
            border-color: var(--accent);
            background: rgba(16, 163, 127, 0.1);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.6;
        }

        .upload-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        input[type="file"] {
            display: none;
        }

        /* æŒ‰é’® */
        .btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
            margin-top: 8px;
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* è®¾ç½®åŒºåŸŸ */
        .settings-section {
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .setting-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        input[type="range"] {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
            color: var(--accent);
        }

        /* æ–‡ä»¶åˆ—è¡¨ */
        .file-list {
            margin-top: 16px;
        }

        .file-list-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .file-item {
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }

        /* ä¸»èŠå¤©åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* æ¶ˆæ¯åŒºåŸŸ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--bg-tertiary);
        }

        /* æ¶ˆæ¯ */
        .message {
            display: flex;
            gap: 16px;
            padding: 24px 0;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: var(--user-msg);
            margin-left: 0;
            margin-right: 0;
            padding: 24px;
            border-radius: 8px;
        }

        .message.assistant {
            background: transparent;
        }

        .message.system {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-radius: 6px;
            border-left: 3px solid var(--accent);
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .avatar.user {
            background: var(--accent);
        }

        .avatar.assistant {
            background: var(--bg-tertiary);
        }

        .message-content {
            flex: 1;
            line-height: 1.6;
            font-size: 15px;
            white-space: pre-wrap;
        }

        .message.system .message-content {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* æµå¼è¾“å‡ºå…‰æ ‡æ•ˆæœ */
        .message-content.streaming::after {
            content: 'â–‹';
            animation: blink 1s infinite;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .sources {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            border-left: 3px solid var(--accent);
        }

        .sources-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-container {
            border-top: 1px solid var(--border);
            padding: 20px;
            background: var(--bg-secondary);
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-box {
            display: flex;
            gap: 12px;
            align-items: center;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 16px;
            transition: all 0.2s ease;
        }

        .input-box:focus-within {
            border-color: var(--accent);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.6;
            font-family: inherit;
            resize: none;
            outline: none;
            max-height: 200px;
            padding: 2px 0;
            display: flex;
            align-items: center;
        }

        textarea::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            max-width: 400px;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 53px;
                bottom: 0;
                transform: translateX(-100%);
                z-index: 50;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .stats-pill {
                display: none;
            }

            .message {
                padding: 16px 0;
            }

            .messages-container {
                padding: 12px;
            }

            .input-container {
                padding: 12px;
            }
        }

        /* ç§»åŠ¨ç«¯èœå•æŒ‰é’® */
        .menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .menu-btn {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-brand">
            <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
            <span class="logo">ğŸŒ¿</span>
            <span>ç”Ÿæ€å­¦æ–‡çŒ®çŸ¥è¯†åº“</span>
        </div>
        <div class="stats-pill">
            <div class="stat-item">
                <span>ğŸ“„</span>
                <span class="stat-value" id="totalFiles">0</span>
                <span>æ–‡ä»¶</span>
            </div>
            <div class="stat-item">
                <span>ğŸ”¢</span>
                <span class="stat-value" id="totalChunks">0</span>
                <span>ç‰‡æ®µ</span>
            </div>
            <div class="stat-item">
                <span>ğŸ¦œ</span>
                <span>Qwen 2.5</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">æ–‡æ¡£ç®¡ç†</div>
            </div>
            
            <div class="sidebar-content">
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">ğŸ“¤</div>
                        <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶ä¸Šä¼ </div>
                        <div class="upload-text" style="font-size: 11px; margin-top: 4px;">æ”¯æŒ PDFã€TXT</div>
                    </div>
                    <input type="file" id="fileInput" accept=".pdf,.txt" multiple>
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        <span>ğŸ“</span>
                        <span>é€‰æ‹©æ–‡ä»¶</span>
                    </button>
                    <button class="btn btn-danger" onclick="clearDatabase()">
                        <span>ğŸ—‘ï¸</span>
                        <span>æ¸…ç©ºçŸ¥è¯†åº“</span>
                    </button>
                </div>

                <!-- è®¾ç½® -->
                <div class="settings-section">
                    <label class="setting-label">æ£€ç´¢æ–‡æ¡£æ•°é‡ (Top K)</label>
                    <div class="slider-container">
                        <input type="range" id="topK" min="1" max="10" value="4" 
                               oninput="document.getElementById('topKValue').textContent = this.value">
                        <span class="slider-value" id="topKValue">4</span>
                    </div>
                </div>

                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div class="file-list" id="fileListContainer">
                    <div class="file-list-title">å·²ä¸Šä¼ æ–‡ä»¶</div>
                    <div id="fileList"></div>
                </div>
            </div>
        </aside>

        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <main class="main-content">
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">ğŸ’¬</div>
                    <div class="empty-title">å¼€å§‹å¯¹è¯</div>
                    <div class="empty-subtitle">ä¸Šä¼ ç”Ÿæ€å­¦æ–‡çŒ®ï¼Œç„¶åå‘ AI æé—®ä»»ä½•ç›¸å…³é—®é¢˜</div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-container">
                <div class="input-wrapper">
                    <div class="input-box">
                        <textarea 
                            id="questionInput" 
                            rows="1"
                            placeholder="è¯¢é—®å…³äºç”Ÿæ€å­¦çš„ä»»ä½•é—®é¢˜..."
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="askQuestion()">
                            â†‘
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    let hasMessages = false;
    let isGenerating = false; // ä¹‹å‰æ¼æ‰äº†è¿™ä¸ªå˜é‡å®šä¹‰
    let currentMessageElement = null;
    let currentSources = [];
    let messageIdCounter = 0;

    // åˆ‡æ¢ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    // è‡ªåŠ¨è°ƒæ•´ textarea é«˜åº¦
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
    }

    // å¤„ç†é”®ç›˜äº‹ä»¶
    function handleKeyDown(event) {
            // 1. å¦‚æœæ­£åœ¨è¾“å…¥æ³•åˆæˆæ–‡å­—ï¼ˆæ‹¼éŸ³æ‰“å­—ä¸­ï¼‰ï¼Œç›´æ¥è¿”å›ï¼Œä¸è§¦å‘åç»­é€»è¾‘
        if (event.isComposing || event.keyCode === 229) {
            return;
        }

        // 2. å¤„ç†å›è½¦é”®
        if (event.key === 'Enter') {
            // å¦‚æœæŒ‰ä¸‹äº† Shift + Enterï¼Œåˆ™æ˜¯æ¢è¡Œï¼Œä¸å¹²æ¶‰é€»è¾‘
            if (event.shiftKey) {
                return;
            }

            // å¦‚æœåªæŒ‰äº† Enterï¼š
            // é˜»æ­¢é»˜è®¤æ¢è¡Œè¡Œä¸º
            event.preventDefault();

            // --- æ ¸å¿ƒæ”¹åŠ¨ç‚¹ ---
            // æ–¹æ¡ˆ Aï¼šå¦‚æœä½ å¸Œæœ›å®Œå…¨å–æ¶ˆâ€œå›è½¦å‘é€â€ï¼Œå¿…é¡»ç‚¹æŒ‰é’®ï¼Œè¯·æ³¨é‡Šæ‰ä¸‹é¢è¿™ä¸€è¡Œ
            // æ–¹æ¡ˆ Bï¼šå¦‚æœä½ å¸Œæœ›â€œèªæ˜åœ°å‘é€â€ï¼ˆä»…åœ¨éè¾“å…¥æ³•çŠ¶æ€ä¸‹æ‰å›è½¦å‘é€ï¼‰ï¼Œä¿ç•™ä¸‹é¢è¿™ä¸€è¡Œ
            askQuestion(); 
        }
    }

    // æ›´æ–° UI çŠ¶æ€ï¼ˆæŒ‰é’®ç¦ç”¨ç­‰ï¼‰
    function updateUIState() {
        const sendBtn = document.getElementById('sendBtn');
        const input = document.getElementById('questionInput');
        if (isGenerating) {
            sendBtn.disabled = true;
            sendBtn.innerHTML = '...';
            input.placeholder = "AI æ­£åœ¨æ€è€ƒä¸­...";
        } else {
            sendBtn.disabled = false;
            sendBtn.innerHTML = 'â†‘';
            input.placeholder = "è¯¢é—®å…³äºç”Ÿæ€å­¦çš„ä»»ä½•é—®é¢˜...";
        }
    }

    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    async function handleFiles(files) {
        for (let file of files) {
            await uploadFile(file);
        }
        loadStats();
    }

    async function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch('/upload', { method: 'POST', body: formData });
            const result = await response.json();
            if (response.ok) {
                addMessage('system', `âœ… ${result.filename} ä¸Šä¼ æˆåŠŸï¼`);
            } else {
                addMessage('system', `âŒ ä¸Šä¼ å¤±è´¥: ${result.detail}`);
            }
        } catch (error) {
            addMessage('system', `âŒ ä¸Šä¼ é”™è¯¯: ${error.message}`);
        }
    }

    // ã€æ ¸å¿ƒä¿®å¤ã€‘æé—®å‡½æ•°
    async function askQuestion(messageId = null) {
        const input = document.getElementById('questionInput');
        const question = input.value.trim();
        
        if (!question || isGenerating) return;

        const topK = parseInt(document.getElementById('topK').value);
        
        if (!hasMessages) {
            document.getElementById('emptyState').style.display = 'none';
            hasMessages = true;
        }

        if (messageId === null) {
            addMessage('user', question);
        }

        input.value = '';
        input.style.height = 'auto';
        
        isGenerating = true;
        updateUIState();
        currentMessageElement = createMessageElement('assistant');
        currentSources = [];

        try {
            const response = await fetch('/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    question: question, 
                    top_k: topK,
                    message_id: messageId   // å‘é€ç»™åç«¯
                })
            });

            if (!response.ok) throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n\n');
                buffer = lines.pop(); 

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine.startsWith('data: ')) continue;
                    
                    try {
                        const data = JSON.parse(trimmedLine.replace('data: ', ''));
                        if (data.type === 'sources') {
                            currentSources = data.data;
                        } else if (data.type === 'text') {
                            appendToMessage(data.data);
                        } else if (data.type === 'done') {
                            finishMessage(currentSources);
                        } else if (data.type === 'error') {
                            addMessage('system', 'âŒ é”™è¯¯: ' + data.data);
                        }
                    } catch (e) { console.error('JSON è§£æå¤±è´¥', e); }
                }
            }
        } catch (error) {
            addMessage('system', 'âŒ è¿æ¥å¤±è´¥: ' + error.message);
        } finally {
            isGenerating = false;
            updateUIState();
        }
    }

// æ–°å¢ï¼šä¸‰ä¸ªç¼–è¾‘å‡½æ•°ï¼ˆæœ€å°å®ç°ï¼‰
    function editMessage(msgId) {
        const messageDiv = document.querySelector(`[data-message-id="${msgId}"]`);
        const contentDiv = messageDiv.querySelector('.message-content');
        const originalText = contentDiv.textContent;

        contentDiv.innerHTML = `
            <textarea class="edit-textarea">${originalText}</textarea>
            <div class="edit-actions">
                <button class="btn-save" onclick="saveEdit(${msgId})">ğŸ’¾ ä¿å­˜å¹¶é‡æ–°ç”Ÿæˆ</button>
                <button class="btn-cancel" onclick="cancelEdit(${msgId}, '${originalText.replace(/'/g, "\\'")}')">âœ–ï¸ å–æ¶ˆ</button>
            </div>
        `;
    }

    async function saveEdit(msgId) {
        const messageDiv = document.querySelector(`[data-message-id="${msgId}"]`);
        const textarea = messageDiv.querySelector('textarea');
        const newContent = textarea.value.trim();
        if (!newContent) return;

        // æ›´æ–°ç”¨æˆ·æ¶ˆæ¯æ–‡å­—
        const contentDiv = messageDiv.querySelector('.message-content');
        contentDiv.textContent = newContent;

        // åˆ é™¤è¯¥æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆåŒ…æ‹¬æ—§çš„ AI å›ç­”ï¼‰
        let nextSibling = messageDiv.nextElementSibling;
        while (nextSibling) {
            const toRemove = nextSibling;
            nextSibling = nextSibling.nextElementSibling;
            toRemove.remove();
        }

        // é‡æ–°ç”Ÿæˆç­”æ¡ˆ
        document.getElementById('questionInput').value = newContent;
        await askQuestion(msgId);
    }

    function cancelEdit(msgId, originalText) {
        const messageDiv = document.querySelector(`[data-message-id="${msgId}"]`);
        const contentDiv = messageDiv.querySelector('.message-content');
        contentDiv.textContent = originalText;
    }


    function createMessageElement(type) {
        const container = document.getElementById('messagesContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = type === 'assistant' 
            ? `<div class="avatar assistant">ğŸ¦œ</div><div class="message-content streaming"></div>`
            : `<div class="avatar user">ğŸ‘¤</div><div class="message-content"></div>`;
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
        return messageDiv.querySelector('.message-content');
    }

    function appendToMessage(text) {
        if (currentMessageElement) {
            currentMessageElement.textContent += text;
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }
    }

    function finishMessage(sources) {
        if (currentMessageElement) {
            currentMessageElement.classList.remove('streaming');
            if (sources && sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'sources';
                sourcesDiv.innerHTML = `<div class="sources-title">ğŸ“š å‚è€ƒæ¥æº</div>` + 
                    sources.map(s => `<div>â€¢ ${escapeHtml(s)}</div>`).join('');
                currentMessageElement.parentElement.appendChild(sourcesDiv);
            }
            currentMessageElement = null;
        }
    }

    function addMessage(type, content) {
        const container = document.getElementById('messagesContainer');
        const div = document.createElement('div');
        div.className = `message ${type}`;
        if (type === 'user') {
            const msgId = messageIdCounter++;
            div.dataset.messageId = msgId;
            div.innerHTML = `
                <div class="avatar user">ğŸ‘¤</div>
                <div class="message-content">${escapeHtml(content)}</div>
                <div class="message-actions">
                    <button class="icon-btn" onclick="editMessage(${msgId})">âœï¸ ç¼–è¾‘</button>
                </div>
            `;
        } else {
            div.innerHTML = `<div class="message-content">${type === 'system' ? content : escapeHtml(content)}</div>`;
        }
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function loadStats() {
        try {
            const response = await fetch('/stats');
            const data = await response.json();
            document.getElementById('totalChunks').textContent = data.total_chunks;
            document.getElementById('totalFiles').textContent = data.total_files;
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = data.files.length > 0 
                ? data.files.map(file => `<div class="file-item">ğŸ“„ ${escapeHtml(file)}</div>`).join('')
                : '<div class="file-item" style="opacity: 0.5;">æš‚æ— æ–‡ä»¶</div>';
        } catch (e) { console.error(e); }
    }

    async function clearDatabase() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºçŸ¥è¯†åº“å—ï¼Ÿ')) return;
        try {
            const res = await fetch('/clear', { method: 'DELETE' });
            const result = await res.json();
            addMessage('system', 'âœ… ' + result.message);
            loadStats();
        } catch (e) { addMessage('system', 'âŒ æ¸…ç©ºå¤±è´¥'); }
    }

    loadStats();
    </script>
</body>
</html>